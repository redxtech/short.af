<html>
	<head>
		<title>shawt af baby</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
		<style>
			.animate-spin {
				animation: spin 1s linear infinite;

				@keyframes spin {
					from {
						transform: rotate(0deg);
					}
					to {
						transform: rotate(360deg);
					}
				}
			}
		</style>
	</head>
	<body class="min-h-full">
		<div class="mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">
			<div class="mx-auto max-w-3xl">
				<h1 class="text-3xl font-bold">shawt.af</h1>
				<h3 class="text-xl italic text-gray-700">> <span id="blurb">a simple url shortener</span></h3>
			</div>
		</div>
		<div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
			<div id="form" class="mx-auto max-w-3xl">
				<div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
					<div class="sm:col-span-6">
						<label for="to" class="block font-medium text-gray-700">destination</label>
						<div class="mt-1 flex rounded-md shadow-sm">
							<input type="url" name="to" id="to" placeholder="https://example.com" class="block w-full min-w-0 flex-1 rounded-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
						</div>
					</div>
				</div>
				<div class="mt-6 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
					<div class="sm:col-span-6">
						<label for="from" class="block font-medium text-gray-700">shortcut</label>
						<div class="mt-1 flex rounded-md shadow-sm">
							<span id="from-label" class="inline-flex items-center rounded-l-md border border-r-0 border-gray-300 bg-gray-50 px-3 text-gray-500">shawt.af/</span>
							<input type="text" name="from" id="from" placeholder="leave blank for random value" class="block w-full min-w-0 flex-1 rounded-none rounded-r-md border-gray-300 focus:border-indigo-500 focus:ring-indigo-500">
						</div>
					</div>
				</div>
				<div class="mt-6 grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
					<div class="sm:col-span-6">
						<button type="submit" id="submit" class="inline-flex justify-center rounded-md border border-transparent bg-indigo-500 py-2 px-4 font-medium text-white shadow-sm hover:bg-indigo-600 ease-in-out duration-100 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2">
							<svg id="spinner" class="animate-spin hidden -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
								<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
								<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
							</svg>
							create shortcut
						</button>
					</div>
				</div>
				<div id="success-box" class="hidden rounded-md bg-green-50 p-4 my-6">
					<div class="flex">
						<div class="flex-1 md:flex md:justify-between">
							<p class="text-green-700">your shortened link has been created & copied to clipboard: <a id="success-url" href="#" target="_blank" class="font-bold underline">#</a></p>
						</div>
					</div>
				</div>
				<div id="failure-box" class="hidden rounded-md bg-red-50 p-4 my-6">
					<div class="flex">
						<div class="flex-1 md:flex md:justify-between">
							<p class="text-red-700">link creation failed: <span id="failure-span" class="font-bold">reason</span></p>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="absolute bottom-2 left-2">
			<div id="q" class="bg-gray-200 hover:bg-gray-300 ease-in-out duration-100 cursor-pointer rounded-full h-10 w-10 flex justify-center items-center">
				<span class="font-bold text-2xl text-gray-700">?</span>
			</div>
		</div>
		<dialog id="about" class="backdrop rounded-lg p-0 max-w-3xl">
			<div class="bg-white rounded-lg px-6 py-8 ring-1 ring-slate-900/5 shadow-xl">
				<h2 class="text-2xl">about shawt.af</h2>
				<div class="my-4 text-slate-500">
					<p class="my-2">
						shawt.af is a simple url shortener that was initially inspired by <a href="http://web.archive.org/web/20180118090335/http://short.af/" target="_blank" class="underline focus:outline-none">short.af</a>.
						i wanted to make my urls short as f*&k, so after years of living with long-ass links, i finally bought this domain name and made something with it.
					</p>
					<p class="my-2">
						the source is available <a href="https://github.com/redxtech/yoinked" target="_blank" class="underline">on github</a>, you're welcome to contribute changes, or get help with self-hosting.
					</p>
					<p>
						all urls are checked against <a href="https://developers.google.com/safe-browsing/v4/advisory" target="_blank" class="underline">google's safe browsing api</a>
						before shortening in order to protect users against malware & phishing sites.
						if you wish to disable this, you can host your own instance of this software and leave the api key blank in the configuration.
					</p>
				</div>
				<h2 class="text-2xl">about me</h2>
				<div class="my-4 text-slate-500">
					<p class="my-2">
						my name is gabe dunn and i'm a fullstack software developer. you can find more information about me and my projects at either
						<a href="https://gabedunn.dev" target="_blank" class="underline">my homepage</a> or <a href="https://github.com/redxtech" target="_blank" class="underline">my github</a> page.
					</p>
				</div>
				<h2 class="text-2xl">api reference</h2>
				<div class="my-4">
					<h4 class="text-base"><code>GET /:shortcut</code></h4>
					<p class="my-2 text-slate-500">
						visting <code>/:shortcut</code> will result in a 302 redirect to the destination url if a shortcut exists, and a 404 otherwise
					</p>
					<h4 class="text-base"><code>GET /expand/:shortcut</code></h4>
					<p class="my-2 text-slate-500">
						visting <code>/expand/:shortcut</code> will return the destination url in plain text if a shortcut exists, and 404 if it doesn't exist
					</p>
					<h4 class="text-base"><code>POST /shorten</code></h4>
					<p class="my-2 text-slate-500">
						the <code>/shorten</code> endpoint takes two parameters: <code>{from, to}</code>. omitting <code>from</code> will allow the server to generate a random shortcut for the url.
						this will return the shortcut object with a 201 status if sucessful, a 403 if the url is flagged as malicious, 422 if the shortcut already exists, and 400 for any other errors.
					</p>
				</div>
				<form class="m-0" method="dialog">
					<button class="inline-flex justify-center rounded-md border border-transparent bg-indigo-500 py-2 px-4 font-medium text-white shadow-sm hover:bg-indigo-600 ease-in-out duration-100 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-offset-2">close</button>
				</form>
			</div>

		</dialog>
		<script>
			document.addEventListener('DOMContentLoaded', () => {
        // focus form on pageload
        const toInput = document.getElementById('to')
        toInput.focus()

        // set from label to current host
        document.getElementById('from-label').innerText = window.location.host

				// function to submit the form
				const submitForm = async () => {
					// get data from the page
					const from = document.getElementById('from').value
          const to = toInput.value

					// get page elements for later use
					const spinner = document.getElementById('spinner')
					const successBox = document.getElementById('success-box')
					const failureBox = document.getElementById('failure-box')
					const link = document.getElementById('success-url')
					const error = document.getElementById('failure-span')

					// hide all showing boxes
					successBox.classList.add('hidden')
					failureBox.classList.add('hidden')

					// make sure destination isn't left blank
					if (!to) {
						error.innerText = 'destination can\'t be left blank'
						failureBox.classList.remove('hidden')
						return
					}

					// make sure destination is a valid url
					let validURL = true
					let url
					try {
						url = new URL(to)
					} catch {
						validURL = false
					} finally {
						if (url?.protocol === 'http:' || url?.protocol === 'https:') {
							validURL = true
						}
					}

					if (!validURL) {
						error.innerText = 'destination must be a valid url'
						failureBox.classList.remove('hidden')
						return
					}

					// start spinner
					spinner.classList.remove('hidden')

					try {
						// call the shortening api
						const req = await fetch('/shorten', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify({ from, to })
						})

						const resp = await req.json()

						if (req.status === 201) {
              const shortUrl = `${window.location.protocol}//${window.location.host}/${resp.from}`
							// fill out the link with the new link information
							link.href = '/' + resp.from
							link.innerText = shortUrl

              // copy url to clipboard
              navigator.clipboard.writeText(shortUrl)

							// show the success box
							successBox.classList.remove('hidden')
						} else {
							// fill out the span with the error message
							error.innerText = `${resp.error} (${req.status})`

							// show the failure box
							failureBox.classList.remove('hidden')
						}
					} catch (err) {
						error.innerText = err
						failureBox.classList.remove('hidden')
					}

					// stop the spinner
					spinner.classList.add('hidden')
				}

				// add click listener to submit button & enter listener to the form
				document.getElementById('submit').addEventListener('click', submitForm)
				document.getElementById('form').addEventListener('keyup', (e) => {
					if (e.keyCode === 13) {
						submitForm()
					}
				})

				// add click listener to the question mark to open dialog
				document.getElementById('q').addEventListener('click', () => {
					document.getElementById('about').showModal()
				})

				// choose a random slogan to display on page load
				const selectFrom = arr => arr[Math.floor((Math.random() * arr.length))]
				const blurb = selectFrom([
					'a simple url shortener',
					'makes your links shawt as f*&k!',
					'hello friend',
					'now with full colour!',
					'no lower case Ls or upper case Is!',
					'your link but smol',
					'beep beep boop borp',
					'hello world!',
					'help i\'ve been trapped inside a url shortener!'
				])
				document.getElementById('blurb').innerText = blurb

			})
		</script>
	</body>
</html>

